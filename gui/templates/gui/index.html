{% extends 'gui/base.html' %}

{% block content %}

<title>{{ cruise.id }} Cruise Management</title>
<h1>{{ cruise.id }} Cruise Management</h1>

{% if cruise %}  
  {# ######################################################################## #}
  {# Draw the loggers and their current configurations.                       #}
  <table style="background-color:white">
    <tr id="server_row">
      <td>
        <button type="submit" id="status_server_button"
                name="StatusServer" value=""
                disabled style="background-color:orangered">Status Server
        </button>
      </td>
      <td>
        <a href="#" onclick="message_window('StatusServer');return false;">
          server log</a>
      </td>
      <td>
        <button type="submit" id="logger_server_button"
                name="LoggerServer" value=""
                disabled style="background-color:orangered">Logger Server
        </button>
      </td>
      <td>
        <a href="#" onclick="message_window('LoggerServer');return false;">
          server log</a>
      </td>
    </tr>
    
    <tr id="time_row">
      <td colspan=4>Last update:
        <span id="time_td">no connection - is status server running?</span>
      </td>
    </tr>
    <tr id="time_warning_row" style="display:none;">
      <td colspan=4>
        Now:<span id="time_warning_td"></span>
      </td>
    </tr>
  </table>
  <hr>
  <table>
    <tr><th>logger</th><th colspan=3>configuration</th></tr>
    {% for logger, config in loggers.items %}
    <tr id="{{ logger }}_row">
      <td id="{{ logger }}_td">{{ logger }}</td>
      <td id="{{ logger }}_config_td">
        {% if user.is_authenticated %}
          <button id="{{ logger }}_config_button" type="submit"
            onclick="window.open('../edit_config/{{ logger }}', '_blank', 'location=yes,height=180,width=520,scrollbars=yes,status=yes');">
          </button>
        {% else %}
          <span id="{{ logger }}_config_button">
          </span>
        {% endif %}
      </td>
      <td id="{{ logger }}_enabled_td"></td>
      <td style="min-width:0px;padding:0px;" id="{{ logger }}_error"></td>
    </tr>
    {% endfor %}
  </table>      

  {# ######################################################################## #}
  {# If user is authenticated, allow to switch modes. Else just show mode     #}
  <hr>
  {% if user.is_authenticated %}
    <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <p>Mode:
      <select name="select_mode" id="select_mode"
              onchange="highlight_select_mode()">
      {% for mode in modes %}
      <option id="mode_{{ mode }}"
         {% if mode == current_mode %}
         selected
         {% endif %}>
          {{ mode.name }}
      </option> 
      {% endfor %}
    </select>  
    <button type="submit">Change mode</button></p>
    </form>
  {% else %}
    <p>Mode: <b><span id="mode_name">{{ cruise.current_mode }}</span></b></p>
  {% endif %}
{% else %}
  <title>No cruise selected</title>
  <h3>No cruise selected - please select or load cruise</h3>
{% endif %}


<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <p>Cruise:
    <select name="select_cruise" id="select_cruise"
            onchange="highlight_select_cruise()">
      {% for cruise_id in cruise_list %}
      <option id="cruise_{{ cruise_id }}"
              {% if cruise_id == cruise %}
                selected
              {% endif %}>
        {{ cruise_id.id }}
      </option> 
      {% endfor %}
    </select>  
    <button type="submit" onclick="change_cruise()">Select cruise</button></p>
</form>

{# ######################################################################## #}
{# Status bar                                                               #}
{% if cruise %}
Current configuration: {{ cruise.config_filename }}
{% endif %}
{% if user.is_authenticated %}
<form>
  {% csrf_token %}
  <button type="submit"
          onclick="window.open('../load_config', '_blank', 'location=yes,height=140,width=450,scrollbars=yes,status=yes');">
    Load cruise file
  </button>
</form>
{% endif %}

{% comment %}
{# ######################################################################## #}
{# Start/stop django_run_loggers                                            #}
{% if user.is_authenticated %}
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {% if server_running %}
  <button type="submit" name="server" value="stop" style="background-color:indianred">
    Stop server
  </button>
  {% else %}
  <button type="submit" name="server" value="start" style="background-color:lightgreen">
    Start server
  </button>
  {% endif %}
</form>
{% else %}
  {% if server_running %}
    Server running
  {% else %}
    Server not running
  {% endif %}
{% endif %}
{% endcomment %}

{# ######################################################################## #}
{# Display any errors                                                       #}
{% if errors %}
  <p>Error parsing config file: {{ config_error }}</p>
{% endif %}
  <hr>

  <p>
  {% if user.is_authenticated %}
  Logged in as <b>{{ user }}.</b>
  <a href="../logout">Log out</a>
  {% else %}
  <a href="../login"><b>Log in</b></a> to manage servers, configurations or mode
  {% endif %}
  </p>

{# ######################################################################## #}
{# Start of Javascript                                                      #}
<script type="text/javascript">
  // We're after logger statuses, so append '/logger' path
  var websocket_server = "ws://{{ websocket_server }}/logger/{{ cruise.id }}";

  //////////////////////////////////////////////////////////////
  // WebSocket code - need to pull this out into a separate file
  // so we're not duplicating it in each of these files!
  if (! "WebSocket" in window) {
    alert("Warning: websockets not supported by your Browser!");
  }

  // Set timer to retry websocket connection if it closes. Interval is
  // turned off in ws.onopen() if/when we succeed.
  var retry_interval = 3000;
  var retry_websocket_connection;
  var ws;
  
  // Try connecting right off the bat
  connect_websocket();

  function connect_websocket() {
    console.log("Trying to connect to websocket at " + websocket_server);
    ws = new WebSocket(websocket_server);
    
    ws.onopen = function() {
      // We've succeeded in opening - don't try anymore
      console.log("Connected - clearing retry interval");
      clearTimeout(retry_websocket_connection);
    };

    ws.onclose = function() { 
      // websocket is closed.
      console.log("Connection is closed...");

      // Set up an alarm to sleep, then try re-opening websocket
      console.log("Setting timer to reconnect");
      retry_websocket_connection = setTimeout(connect_websocket,
                                              retry_interval);
    };

    ws.onmessage = function (received_message) { 
      console.log("Got status update message: " + received_message.data);
      process_message(JSON.parse(received_message.data));
    };
  };
  
  window.onbeforeunload = function(event) {
    console.log("Closing websocket");
    ws.close();
  };

  function send(message) {
    console.log("Sending message '" + message + "'");
    ws.send(message);
    console.log("Sent!");
  };

  //////////////////////////////////////////////////////
  // Start of index.html-specific Javascript

  // If no update in 5 seconds, change background color to red
  var TIMEOUT_INTERVAL = 5000;
  function flag_timeout() {
    document.getElementById("time_row").style.backgroundColor = "orangered";
    document.getElementById("time_warning_td").innerHTML = Date();
    document.getElementById("time_warning_row").style.display = "";

    document.getElementById("status_server_button").style.backgroundColor = "yellow";
    document.getElementById("logger_server_button").style.backgroundColor = "yellow";
      var status_button = document.getElementById("status_server_button");
  }
  var timeout_timer = setInterval(flag_timeout, TIMEOUT_INTERVAL);

  var cruise_loaded_time = 0;

  function process_message(message) {
    // Fill in the values we've received

    // Update time string and reset timeout timer
    document.getElementById("time_td").innerHTML = Date();
    document.getElementById("time_warning_row").style.display = "none";
    document.getElementById("time_row").style.backgroundColor = "white";

    //document.getElementById("time_str").innerHTML = message.time_str;

    //time_str.style.backgroundColor = "white";

    clearInterval(timeout_timer);
    timeout_timer = setInterval(flag_timeout, TIMEOUT_INTERVAL);

    var status = message.status;
    if (status) {
      // Has cruise changed behind our back? If so, reload
      if (cruise_loaded_time == 0) {
        cruise_loaded_time = status.cruise_loaded_time;
      }
      if (status.cruise_loaded_time > cruise_loaded_time) {
        window.location.reload(true);
      }

      // Update mode - "select_mode" only defined if user is authenticated;
      // otherwise we should have "mode_name"

      var status_button = document.getElementById("status_server_button");
      if (status.StatusServer.running != status.StatusServer.desired) {
        status_button.style.backgroundColor = "yellow";
      } else if (status.StatusServer.running) {
        status_button.style.backgroundColor = "lightgreen";
      } else {
        status_button.style.backgroundColor = "orangered";
      }
      var logger_button = document.getElementById("logger_server_button");
      if (status.LoggerServer.running != status.LoggerServer.desired) {
        logger_button.style.backgroundColor = "yellow";
      } else if (status.LoggerServer.running) {
        logger_button.style.backgroundColor = "lightgreen";
      } else {
        logger_button.style.backgroundColor = "orangered";
      }

      if (select_mode) {
        select_mode.value = status.current_mode;
      } else {
        document.getElementById("mode_name").innerHTML = status.current_mode;
      }
      for (var logger_name in status.loggers) {
        //console.log('processing status for ' + logger_name);
        var values = status.loggers[logger_name];
        var desired = values['desired_config'] || "";
        var current = values['current_config'] || "";
        var mode_match = values['mode_match'] || "";
        var enabled = values['current_enabled'] || "";
        var error = values['current_error'] || "";

        var row = document.getElementById(logger_name + "_row")
        var config_td = document.getElementById(logger_name + "_config_td");
        var config_button = document.getElementById(logger_name + "_config_button");
        var enabled_td = document.getElementById(logger_name + "_enabled_td");
        var error_td = document.getElementById(logger_name + "_error");
  
        // If we can't find a row, maybe things have changed out
        // from under us? Try reloading.
        if (!row) {
          console.log("Couldn't find row for " + logger_name);
          window.location.reload(true);
        }

        if (current) {
          config_button.innerHTML = current;
        } else {
          config_button.innerHTML = "--None--";
        }

        if (enabled) {
          enabled_td.innerHTML = "";
        } else {
          enabled_td.innerHTML = "disabled";
        }

        if (!current && !desired) {
          row.style.backgroundColor = "lightgray";
        } else if (current == desired) {
          if (enabled) {
            row.style.backgroundColor = "lightgreen";         
          } else {
            row.style.backgroundColor = "lightgray";
          }
        // If current config is not equal to desired
        } else if (error) {
          row.style.backgroundColor = "orangered";
        } else {
            row.style.backgroundColor = "yellow";  
        }

        // If the current_config doesn't match the default config
        // for the current mode, flag the config as different
        if (current && !mode_match) {
          config_td.style.backgroundColor = "yellow";
        } else {
          config_td.style.backgroundColor = row.style.backgroundColor;
        }

        // Finally, do we have an error reported for this logger?
        error_td.innerHTML = error;
        if (error) {
          row.style.backgroundColor = "orangered";
          config_td.style.backgroundColor = "orangered";
          error_td.style.backgroundColor = "orangered";
        } else {
          error_td.style.backgroundColor = row.style.backgroundColor;
        }
      }
    }
  };

  ///////////////////////////////
  // Highlight the color of the cruise/mode select option when it has
  // been changed, but before it's committed.
  function highlight_select_cruise() {
    document.getElementById("select_cruise").style.backgroundColor="yellow";
  }  

  ///////////////////////////////
  // Switch to the selected cruise
  function change_cruise() {
    var select = document.getElementById("select_cruise");
    var cruise = select.options[select.selectedIndex].value;
    console.log("Loading page: /cruise/" + cruise);
    history.pushState(cruise, cruise, "/cruise/" + cruise);
    window.location.assign("/cruise/" + cruise);
  }  

  function highlight_select_mode() {
    document.getElementById("select_mode").style.backgroundColor="yellow";
  }  

  ///////////////////////////////
  function edit_config(logger_name) {
    console.log('Edit request for ' + logger_name);
    //loggers = "{{ loggers }}";
    //console.log('Loggers: ' + loggers);
  }

  ///////////////////////////////
  function message_window(server) {
    window.open("server_messages/" + server, "_blank",
    "height=350,width=540,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,copyhistory=no");
  }

</script>

{% endblock content %}
