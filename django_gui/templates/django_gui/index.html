{% extends 'django_gui/base.html' %}

{% block content %}

<title>{{ cruise_id }} Cruise Management</title>
<h1>{{ cruise_id }} Cruise Management</h1>

{# ######################################################################## #}
{# Show server status up top.                                               #}
<table style="background-color:white">
  <tr id="time_row">
    <td colspan=4>Last update:
      <span id="time_td">no connection - is status server running?</span>
    </td>
  </tr>
  <tr id="time_warning_row" style="display:none;">
    <td colspan=4>
      Now: <span id="time_warning_td"></span>
    </td>
  </tr>
  <tr id="server_row">
    <td>
      <a href="#" onclick="message_window();return false;">
        server log</a>
    </td>
  </tr>
</table>
    
{# ######################################################################## #}
{# Draw the loggers and their current configurations.                       #}
{% if cruise_id %}      
  <hr>
  <table>
    <tr><th>logger</th><th colspan=3>configuration</th></tr>
    {% for logger_name, logger_config in loggers.items %}
    <tr id="{{ logger_name }}_row">
      <td id="{{ logger_name }}_td">{{ logger_name }}</td>
      <td id="{{ logger_name }}_config_td">
        <button id="{{ logger_name }}_config_button" type="submit"
                onclick="window.open('../edit_config/{{ cruise_id }}/{{logger_name }}', '_blank', 'location=yes,height=180,width=520,scrollbars=yes,status=yes');"
                {% if not user.is_authenticated %}
                  disabled
                {% endif %}
                >
          {{ logger_config }}
        </button>
      </td>
      <td style="min-width:0px;padding:0px;" id="{{ logger_name }}_error"></td>
    </tr>
    {% endfor %}
  </table>      

  {# ######################################################################## #}
  {# If user is authenticated, allow to switch modes. Else just show mode     #}
  <hr>
  {% if user.is_authenticated %}
    <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <p>Mode:
      <select name="select_mode" id="select_mode"
              onchange="highlight_select_mode()">
      {% for mode_option in modes %}
      <option id="mode_{{ mode_option }}"
         {% if mode_option == current_mode %}
         selected
         {% endif %}>
          {{ mode_option }}
      </option> 
      {% endfor %}
    </select>  
    <button type="submit">Change mode</button></p>
    </form>
  {% else %}
    <p>Mode: <b><span id="mode_name">{{ current_mode }}</span></b></p>
  {% endif %}
{% else %}
  <title>No cruise selected</title>
  <h3>No cruise selected - please select or load cruise</h3>
{% endif %}


<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <p>Cruise:
    <select name="select_cruise" id="select_cruise"
            onchange="highlight_select_cruise()">
      <option value="" disabled selected>----</option>
        {% for cruise_id_option in cruise_list %}
      <option id="cruise_{{ cruise_id_option }}"
              {% if cruise_id_option == cruise_id %}
                selected
              {% endif %}>
        {{ cruise_id_option }}
      </option> 
      {% endfor %}
    </select>  
    <button type="submit" onclick="change_cruise()">Select cruise</button></p>
</form>

{# ######################################################################## #}
{# Load configuration                                                       #}
{% if user.is_authenticated %}
<hr>
<div id="load_div_button">
  <button type="submit" onclick="toggle_load_config_div()">
  Load cruise file
  </button>
</div>
<div id="load_config_div" style="display:none">
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <table>
      <tr>
        <td>
          <input id="config_file" type="file" name="config_file" size="20"
                 onchange="show_load_button(this.files)">
        </td>
        <td>
          <div id="load_button_div"  style="display:none">
            <button type="submit" id="load_cruise_button"
                    name="load_cruise">
              Load
            </button>
          </div>
        </td>
        <td>
          <button onclick="toggle_load_config_div();" name="cancel">
            Cancel
          </button>
        </td>
      </tr>
    </table>
  </form>
</div>

{% endif %}

{# ######################################################################## #}
{# Display any errors                                                       #}
{% if errors %}
<p>
  <font color="red">
    {% for error in errors %}
      {{ error }}<br>
    {% endfor %}
  </font>
</p>
{% endif %}
<hr>

<p>
  {% if user.is_authenticated %}
  Logged in as <b>{{ user }}.</b>
  <a href="../logout">Log out</a>
  {% else %}
  <a href="../login"><b>Log in</b></a> to manage servers, configurations or mode
  {% endif %}
</p>

{# ######################################################################## #}
{# Start of Javascript                                                      #}
<script type="text/javascript">
  // We're after logger statuses, so append '/logger' path
  var websocket_server = "ws://{{ websocket_server }}/logger_status/{{ cruise_id }}";

  //////////////////////////////////////////////////////////////
  // WebSocket code - need to pull this out into a separate file
  // so we're not duplicating it in each of these files!
  if (! "WebSocket" in window) {
    alert("Warning: websockets not supported by your Browser!");
  }

  // Set timer to retry websocket connection if it closes. Interval is
  // turned off in ws.onopen() if/when we succeed.
  var retry_interval = 3000;
  var retry_websocket_connection;
  var ws;
  
  // Try connecting right off the bat
  connect_websocket();

  function connect_websocket() {
    console.log("Trying to connect to websocket at " + websocket_server);
    ws = new WebSocket(websocket_server);
    
    ws.onopen = function() {
      // We've succeeded in opening - don't try anymore
      console.log("Connected - clearing retry interval");
      clearTimeout(retry_websocket_connection);
    };

    ws.onclose = function() { 
      // websocket is closed.
      console.log("Connection is closed...");

      // Set up an alarm to sleep, then try re-opening websocket
      console.log("Setting timer to reconnect");
      retry_websocket_connection = setTimeout(connect_websocket,
                                              retry_interval);
    };

    ws.onmessage = function (received_message) { 
      //console.log("Got status update message: " + received_message.data);
      process_message(JSON.parse(received_message.data));
    };
  };
  
  window.onbeforeunload = function(event) {
    console.log("Closing websocket");
    ws.close();
  };

  function send(message) {
    console.log("Sending message '" + message + "'");
    ws.send(message);
    console.log("Sent!");
  };

  //////////////////////////////////////////////////////
  // Start of index.html-specific Javascript

  // If no update in 5 seconds, change background color to red
  var TIMEOUT_INTERVAL = 5000;
  function flag_timeout() {
    document.getElementById("time_row").style.backgroundColor = "orangered";
    document.getElementById("time_warning_td").innerHTML = Date();
    document.getElementById("time_warning_row").style.display = "";
  }

  var timeout_timer = setInterval(flag_timeout, TIMEOUT_INTERVAL);

  ////////////////////////////
  function process_message(message) {
    // Fill in the values we've received

    // Update time string and reset timeout timer
    document.getElementById("time_td").innerHTML = Date();
    document.getElementById("time_warning_row").style.display = "none";
    document.getElementById("time_row").style.backgroundColor = "white";

    //document.getElementById("time_str").innerHTML = message.time_str;

    //time_str.style.backgroundColor = "white";

    clearInterval(timeout_timer);
    timeout_timer = setInterval(flag_timeout, TIMEOUT_INTERVAL);

    // If we're being told to refresh the page, do that before anything else
    if (message.refresh == true) {
      window.location.reload(true);
    }
    // Do we have a mode specification? If so, update
    if (message.mode) {
      var selected_mode = document.getElementById("mode_" + message.mode);
      if (selected_mode) {
        console.log("setting mode selection: " + message.mode);
        selected_mode.selected = true;
      } else {
        var mode_name_box = document.getElementById("mode_name");
        if (mode_name_box) {
          console.log("setting mode name box: " + message.mode);
          mode_name_box.innerHTML = message.mode;
        }
      }
    }
    // Do we have logger config update?
    if (message.loggers) {
      for (var logger_name in message.loggers) {
        var logger_config = message.loggers[logger_name];
        //console.log("processing for config " + logger_config);
        var button = document.getElementById(logger_name + "_config_button");
        var error_td = document.getElementById(logger_name + "_error");
        if (button) {
          button.innerHTML = logger_config || "no config";

          // We'd like a way to highlight when things change externally,
          // e.g. by turning button yellow for a couple of seconds. But
          // that will have to wait for later.
          //button.style.backgroundColor = "yellow";

        }
        // If message doesn't include a status, we're done with this logger
        if (!message.status) {
          continue;
        }
        // If message doesn't include a status for this logger, we're done
        var logger_status = message.status[message.cruise_id+":"+logger_name];
        if (!logger_status) {
          continue;
        }

        // Got a ternary status for this logger:
        //   true:  we're running and are supposed to be
        //   false: not running and are supposed to be
        //   null:  not running and not supposed to be
        if (logger_status.running == true) {
          button.style.backgroundColor = "lightgreen";
        } else if (logger_status.running == false) {
          button.style.backgroundColor = "orangered";
        } else {
          button.style.backgroundColor = "lightgray";
        }

        if (logger_status.failed) {
          continue;
        }

        // Display any error messages.
        if (error_td) {
          // Only update error display if logger isn't "failed"
          // otherwise just show last state and errors
          var error_str = logger_status.errors.join(", ");
          if (error_str) {
            error_td.innerHTML = error_str;
            error_td.style.backgroundColor = "orangered";
          } else {
            error_td.innerHTML = "";
            error_td.style.backgroundColor = "lightgray";
          }
        }
      }
    }

  };

  ///////////////////////////////
  // Highlight the color of the cruise/mode select option when it has
  // been changed, but before it's committed.
  function highlight_select_cruise() {
    document.getElementById("select_cruise").style.backgroundColor="yellow";
  }  

  ///////////////////////////////
  // Switch to the selected cruise
  function change_cruise() {
    var select = document.getElementById("select_cruise");
    var cruise = select.options[select.selectedIndex].value;
    console.log("Loading page: /cruise/" + cruise);
    history.pushState(cruise, cruise, "/cruise/" + cruise);
    window.location.assign("/cruise/" + cruise);
  }  

  // Turn select pull-down's text background yellow when it's been changed
  function highlight_select_mode() {
    document.getElementById("select_mode").style.backgroundColor="yellow";
  }  

  ///////////////////////////////
  function load_cruise() {
    var select = document.getElementById("select_cruise");
    var cruise = select.options[select.selectedIndex].value;
    console.log("Loading page: /cruise/" + cruise);
    history.pushState(cruise, cruise, "/cruise/" + cruise);
    window.location.assign("/cruise/" + cruise);
  }

  ///////////////////////////////
  // Toggle whether the cruise file selector is visible
  function toggle_load_config_div() {
    var x = document.getElementById("load_div_button");
    var y = document.getElementById("load_config_div");
    if (x.style.display === "none") {
        x.style.display = "block";
        y.style.display = "none";
    } else {
        x.style.display = "none";
        y.style.display = "block";
    }
  }

  ///////////////////////////////
  // When the cruise file selector has a file selected, show the
  // "load" button
  function show_load_button(files) {
    var load_button_div = document.getElementById("load_button_div");
    if (files.length) {
      load_button_div.style.display = "block";
    } else {
      load_button_div.style.display = "none";
    }
  }

  ///////////////////////////////
  function message_window() {
    window.open("/server_messages/20", "_blank",
    "height=350,width=540,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,copyhistory=no");
  }

</script>

{% endblock content %}
