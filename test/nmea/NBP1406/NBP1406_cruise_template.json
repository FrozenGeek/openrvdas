// Sample JSON cruise definition template to a cruise/installation
//
// Usage:
//
//   logger/utils/build_config \
//      --config test/config/sample_cruise_template.json \
//         > test/config/sample_cruise.json
//
//   server/logger_manager.py \
//      --config test/config/sample_cruise.json \
//      --mode underway
//
// Programmatically, you can load the definition as
//
//   from logger.utils.read_json import read_json
//   from logger.utils.build_config import BuildConfig
//
//   raw_config = read_json('test/configs/sample_cruise_template.json')
//   config = BuildConfig.expand_config(raw_config)
//
// The expanded config dict will have a "modes" key. The value is a
// dict mapping mode names ("off", "port", "underway") to a dictionary
// mapping logger names to the configurations they should be in.
//
// Expansion involves two separate processes: string substitution from
// the "vars" dict, and reference substitution from the "templates"
// dict.
//
// 1. String substitution. The values of the "modes" and "templates"
//    are recursively searched for any strings that contain any of the
//    keys in the "vars" dict. If they are found, substitution is made
//    via string replace.
//
//    E.g., given the variables
//
//      {
//        "%CRUISE%" : "NBP1700",
//        "%LOGFILE_BASE%": "/tmp/log/%CRUISE%"
//      }
//
//    variable substitution will convert
//
//      "filebase": "%LOGFILE_BASE%/%INST%/raw/%CRUISE%_%INST%"
//
//    into
//
//      "filebase": "/tmp/log/NBP1700/%INST%/raw/NBP1700_%INST%"
//
//    The replacement has a special case where the the value may be a
//    list of strings rather than a single string. If the string to be
//    replaced appears in a list or dict key, string substitution will
//    create and insert one replacement string for every value.
//
//    E.g., given
//
//      {
//        "%CRUISE%" : "NBP1700",
//        "%LOGFILE_BASE%": "/tmp/log/%CRUISE%",
//        "%INST%": ["knud", "gyr1", "s330"]
//      }
//
//    and the template
//
//      "writers": [
//        "%INST%_LOGFILE_WRITER",
//      ]
//
//    string substitution will produce
//
//      "writers": [
//        "knud_LOGFILE_WRITER",
//        "gyr1_LOGFILE_WRITER",
//        "s330_LOGFILE_WRITER"
//      ]
//
// 2. Reference substitution. Templates in the "templates" dict are
//    expanded by searching for top-level keys in the dict that appear
//    in the values of another key. If a top-level key appears
//    elsewhere in the dict, the value of that top-level key is
//    swapped as if by reference.
//
//    E.g., given a "templates" dict like the following:
//
//       {
//         "SERIAL_READER": {serial reader definition},
//         "LOGGER": {
//            "readers": "SERIAL_READER",
//            "writers": {writer definition}
//         }
//       }
//
//    Reference substitution would expand it to
//
//       {
//         "SERIAL_READER": {serial reader definition},
//         "LOGGER": {
//            "readers": {serial reader definition},
//            "writers": {writer definition}
//         }
//       }
//
// The order of expansion is:
//
// 1. All inter-variable string substitutions are made within the
//    variables.
// 2. String substitutions are made within the modes.
// 3. String substitutions are made withing the templates.
// 4. Reference substitutions are made from templates into modes.
//
{
    ////////////////////////////////////////////////////////
    // These variables get filled in on the logger templates.
    "vars": {
        // Cruise ID
        "%CRUISE%" : "NBP1406",
        "%START_DATE%" : "2014-06-01",
        "%END_DATE%" : "2014-07-01",

        // Where logfiles should be written
        "%LOGFILE_BASE%": "/tmp/log/%CRUISE%",

        // What port the UDP network writers should read/write
        "%UDP_PORT%": ":6224",

        // All serial-port instruments - these vars are expanded in
        // the generic templates.
        "%SERIAL_INST%": ["PCOD", "gp02", "gyr1", "knud", "mwx1", "pguv", "s330",
                          "svp1", "tsg1", "tsg2", "adcp", "eng1", "grv1", "hdas",
                          "mbdp", "pco2", "rtmp", "seap"],

        // Instruments that should run while in port
        "%PORT_INST%": ["gyr1", "rtmp", "mwx1", "s330", "eng1"],

        // Instruments that should only run while underway
        "%UW_INST%": ["PCOD", "gp02", "knud", "pguv", "svp1", "tsg1", "tsg2",
                      "adcp", "grv1", "hdas", "mbdp", "pco2", "seap"],

        // Instruments that should run while in port
        "%DERIVED_INST%": ["true_winds"]
    },

    "cruise": {
        "id": "%CRUISE%",
        "start": "%START_DATE%",
        "end": "%END_DATE%"
    },

    "loggers": {
        "%SERIAL_INST%": {
            "configs": ["%SERIAL_INST%->off",
                        "%SERIAL_INST%->net",
                        "%SERIAL_INST%->file/net/db"]
        },
        "true_winds": {
            "configs": ["true_winds->off",
                        "true_winds->net",
                        "true_winds->db"]
        }
    },

    ////////////////////////////////////////////////////////
    // Three different cruise modes: off, port, underway
    "modes": {
        // Nothing's running when off
        "off": {
            "%PORT_INST%": "%PORT_INST%->off",
            "%UW_INST%": "%UW_INST%->off",
            "true_winds": "true_winds->off"
        },

        // In port, we only run certain instruments, and don't write to disk
        "port": {
            "%PORT_INST%": "%PORT_INST%->net",
            "%UW_INST%": "%UW_INST%->off",
            "true_winds": "true_winds->off"
        },

        // Monitoring, we observe everything, but don't write to disk
        "monitor": {
            "%PORT_INST%": "%PORT_INST%->net",
            "%UW_INST%": "%UW_INST%->net",
            "true_winds": "true_winds->db"
        },

        // Underway, everything's in default mode of running/saving.
        "monitor and log": {
            "%PORT_INST%": "%PORT_INST%->file/net/db",
            "%UW_INST%": "%UW_INST%->file/net/db",
            "true_winds": "true_winds->db"
        }
    },

    // By default, we should be in mode "off"
    "default_mode": "off",

    ///////////////////////////////////////////////////////
    // Logger configurations - most of these, except the true winds,
    // are templatized to keep them compact.
    "configs": {
        "%SERIAL_INST%->off": {},
        "%SERIAL_INST%->net": "%SERIAL_INST%_LOGGER_NO_WRITE",
        "%SERIAL_INST%->file/net/db": "%SERIAL_INST%_LOGGER",

        "true_winds->off": {},

        "true_winds->net": {
            "name": "true_winds->db",
            "readers": {
                "class": "NetworkReader",
                "kwargs": {
                    "network": ":6224"
                }
            },
            "transforms": [
                { "class": "ParseNMEATransform" },
                {
                    "class": "ComposedDerivedDataTransform",
                    "kwargs": {
                        "transforms": [
                            {
                                "class": "TrueWindsTransform",
                                "kwargs": {
                                    "course_field": "S330CourseTrue",
                                    "speed_field": "S330Speed",
                                    "heading_field": "S330HeadingTrue",
                                    "wind_dir_field": "MwxPortRelWindDir",
                                    "wind_speed_field": "MwxPortRelWindSpeed",
                                    "true_dir_name": "PortTrueWindDir",
                                    "true_speed_name": "PortTrueWindSpeed",
                                    "update_on_fields": ["MwxPortRelWindDir"],
                                    "apparent_dir_name": "PortApparentWindDir",
                                    "convert_speed_factor": 0.5144
                                }
                            },
                            {
                                "class": "TrueWindsTransform",
                                "kwargs": {
                                    "course_field": "S330CourseTrue",
                                    "speed_field": "S330Speed",
                                    "heading_field": "S330HeadingTrue",
                                    "wind_dir_field": "MwxStbdRelWindDir",
                                    "wind_speed_field": "MwxStbdRelWindSpeed",
                                    "true_dir_name": "StbdTrueWindDir",
                                    "true_speed_name": "StbdTrueWindSpeed",
                                    "update_on_fields": ["MwxStbdRelWindDir"],
                                    "apparent_dir_name": "StbdApparentWindDir",
                                    "convert_speed_factor": 0.5144
                                }
                            }
                            // Other derived data transforms should go here
                        ]
                    }
                }
            ],
            "writers": {
                "class": "NetworkWriter",
                "kwargs": { "network": ":6224" }
            }
        },

        "true_winds->db": {
            "name": "true_winds->db",
            "readers": {
                "class": "NetworkReader",
                "kwargs": {
                    "network": ":6224"
                }
            },
            "transforms": [
                { "class": "ParseNMEATransform" },
                {
                    "class": "ComposedDerivedDataTransform",
                    "kwargs": {
                        "transforms": [
                            {
                                "class": "TrueWindsTransform",
                                "kwargs": {
                                    "course_field": "S330CourseTrue",
                                    "speed_field": "S330Speed",
                                    "heading_field": "S330HeadingTrue",
                                    "wind_dir_field": "MwxPortRelWindDir",
                                    "wind_speed_field": "MwxPortRelWindSpeed",
                                    "true_dir_name": "PortTrueWindDir",
                                    "true_speed_name": "PortTrueWindSpeed",
                                    "update_on_fields": ["MwxPortRelWindDir"],
                                    "apparent_dir_name": "PortApparentWindDir",
                                    "convert_speed_factor": 0.5144
                                }
                            },
                            {
                                "class": "TrueWindsTransform",
                                "kwargs": {
                                    "course_field": "S330CourseTrue",
                                    "speed_field": "S330Speed",
                                    "heading_field": "S330HeadingTrue",
                                    "wind_dir_field": "MwxStbdRelWindDir",
                                    "wind_speed_field": "MwxStbdRelWindSpeed",
                                    "true_dir_name": "StbdTrueWindDir",
                                    "true_speed_name": "StbdTrueWindSpeed",
                                    "update_on_fields": ["MwxStbdRelWindDir"],
                                    "apparent_dir_name": "StbdApparentWindDir",
                                    "convert_speed_factor": 0.5144
                                }
                            }
                            // Other derived data transforms should go here
                        ]
                    }
                }
            ],
            "writers": {
                "class": "DatabaseWriter"
            }
        }
    },

    ////////////////////////////////////////////////////////
    // Generic logger definition templates that we're going to draw on
    // to fill in the actual configurations in the cruise modes
    "templates": {
        // Generic logfile writer
        "%SERIAL_INST%_LOGFILE_WRITER": {
               "class": "LogfileWriter",
            "kwargs": {"filebase": "%LOGFILE_BASE%/%SERIAL_INST%/raw/%CRUISE%_%SERIAL_INST%"}
        },

        // Generic network writer - a ComposedWriter that prefixes
        // instrument data_id before writing
        "%SERIAL_INST%_NETWORK_WRITER": {
            "class": "ComposedWriter",
            "kwargs": {
                "transforms": {
                    "class": "PrefixTransform",
                    "kwargs": {"prefix": "%SERIAL_INST%"}
                },
                "writers": {"class": "NetworkWriter",
                            "kwargs": { "network": "%UDP_PORT%" }
                           }
            }
        },

        // Generic database writer - a ComposedWriter that prefixes
        // instrument data_id then parses into DASRecord before writing
        "%SERIAL_INST%_DATABASE_WRITER": {
            "class": "ComposedWriter",
            "kwargs": {
                "transforms": [
                    { "class": "PrefixTransform",
                      "kwargs": {"prefix": "%SERIAL_INST%"}},
                    { "class": "ParseNMEATransform"}
                ],
                "writers": {"class": "DatabaseWriter"}
            }
        },

        // Generic loggers
        // Read from serial, write to network and logfile
        "%SERIAL_INST%_LOGGER": {
            "name": "%SERIAL_INST%->net/file/db",
            "readers": {
                "class": "SerialReader",
                "kwargs": {
                    "port": "/tmp/tty_%SERIAL_INST%",
                    "baudrate": 9600
                }
            },
            "transforms": {"class": "TimestampTransform"},
            "writers": [
                "%SERIAL_INST%_LOGFILE_WRITER",
                "%SERIAL_INST%_NETWORK_WRITER",
                "%SERIAL_INST%_DATABASE_WRITER"
            ]
        },

        // Read from serial, write to network, but not logfile
        "%SERIAL_INST%_LOGGER_NO_WRITE": {
            "name": "%SERIAL_INST%->net",
            "readers": {
                "class": "SerialReader",
                "kwargs": {
                    "port": "/tmp/tty_%SERIAL_INST%",
                    "baudrate": 9600
                }
            },
            "transforms": {"class": "TimestampTransform"},
            "writers": "%SERIAL_INST%_NETWORK_WRITER"
        },

        // Read from serial, write to network and logfile
        "%SERIAL_INST%_LOGGER_NO_NETWORK": {
            "name": "%SERIAL_INST%->file",
            "readers": {
                "class": "SerialReader",
                "kwargs": {
                    "port": "/tmp/tty_%SERIAL_INST%",
                    "baudrate": 9600
                }
            },
            "transforms": {"class": "TimestampTransform"},
            "writers": "%SERIAL_INST%_LOGFILE_WRITER"
        },

        // Read from network, write to logfile
        "%SERIAL_INST%_NETWORK_LOGGER": {
            "name": "%SERIAL_INST%->file",
            "readers":  {
                "class": "SerialReader",
                "kwargs": {
                    "port": "/tmp/tty_%SERIAL_INST%",
                    "baudrate": 9600
                }
            },
            "transforms": {"class": "TimestampTransform"},
            "writers": "%SERIAL_INST%_LOGFILE_WRITER"
        },
        // Read from network, parse and look for broken bounds; write
        // to stdout if they're exceeded
        "%QC_LOGGER%": {
            "name": "qc_logger",
            "readers":  {
                "class": "NetworkReader",
                "kwargs": { "network": "%UDP_PORT%" }
            },
            "transforms": [
                {"class": "ParseNMEATransform"},
                {
                    "class": "QCFilterTransform",
                    "kwargs": {
                        "bounds": "%QC_LIMITS%"
                    }
                }
            ],
            "writers": {"class": "TextFileWriter"}
        }
    }

}
