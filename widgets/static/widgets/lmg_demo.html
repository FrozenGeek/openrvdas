<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NBP UNOLS Widget Example</title>

    <style type="text/css">
      .ship_table {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
      }
      .ship_table td, .ship_table th {
        border: 1px solid #ddd;
        padding: 8px;
      }
      .td_70 {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        text-align: left;
        width: 70%;
      }
      .td_50 {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        text-align: left;
        width: 50%;
      }
      .td_30 {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        text-align: left;
        width: 30%;
      }
      .name_td {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        text-align: left;
        font-weight: bold;
        width: 25%;
      }
      .val_td_50 {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        text-align: left;
        width: 50%;
      }
      .val_td_25 {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        text-align: left;
        width: 25%;
      }
    </style>
  </head>
  <body>
    <!-- This is where we define location of data server. -->
    <script src="/static/js/widgets/settings.js"></script>

    <script src="/static/js/jquery/jquery-3.1.1.min.js"></script>
    <script src="/static/js/highcharts/code/highstock.js"></script>
    <script src="/static/js/highcharts/code/highcharts-more.js"></script>
    <script src="/static/js/highcharts/code/modules/data.js"></script>
    <script src="/static/js/highcharts/code/modules/exporting.js"></script>
    <script src="/static/js/highcharts/code/modules/export-data.js"></script>

    <script src="/static/js/widgets/highcharts_widget.js"></script>
    <script src="/static/js/widgets/text_widget.js"></script>
    <script src="/static/js/widgets/widget_server.js"></script>

    <table class="ship_table">
      <tr>
        <td>

    <table class="ship_table">
      <tr>
        <td class="name_td" colspan=2>
          Lawrence M. Gould Console
        </td>
        <td class="val_td_25">
          Lat: <span id="gps_lat">--.----</span>°
          <span id="gps_n_or_s"></span>
        </td>
        <td class="val_td_25">
          Lon: <span id="gps_lon">--.----</span>°
          <span id="gps_e_or_w"></span>
        </td>
      </tr>

      <tr>
        <td class="val_td_25" colspan=2>
          GMT Time: <span id="gmt_time">--:--:--.--</span>
        </td>
        <td class="val_td_25" colspan=2>
          GMT Day: <span id="gmt_julian_date">---</span>,
          Date: <span id="gmt_day">--</span>-<span id="gmt_month">---</span>-<span id="gmt_year">----</span>
        </td>
      </tr>

      <tr>
        <td colspan=2>
          <div id="rel-wind-container"
               style="height: 300px; width: 310px"></div>
        </td>
        <td colspan=2>
          <div id="true-wind-container"
               style="height: 300px; width: 310px"></div>
        </td>
      </tr>
      <tr>
        <td>Relative Speed
        Port: <span id="port_rel_speed" style="color:red"></span> m/s,</td>
        <td>Stbd: <span id="stbd_rel_speed" style="color:green"></span> m/s</td>
        <td>True Speed
        Port: <span id="port_true_speed" style="color:red"></span> m/s,</td>
        <td>Stbd: <span id="stbd_true_speed" style="color:green"></span> m/s</td>
      </tr>
      <tr>
        <td colspan>
          Course <span id="course_true">-</span>°
        </td>
        <td colspan>
          Heading <span id="heading_true"></span>°
        </td>
        <td colspan>
          Speed over ground <span id="sog_kt">-</span> kts
        </td>
      </tr>
      <tr>
        <td class="name_td">Pitch</td>
        <td class="val_td"><span id="pitch"></span>°</td>
        <td class="name_td">Roll</td>
        <td class="val_td"><span id="roll"></span>°</td>
      </tr>
    </table>
        </td>
      </tr>
    </table>


  <script type="text/javascript">
  var widget_list = [];

  // Lat/Lon text widgets
  widget_list.push(new TextWidget('gps_lat',
                                  {S330Latitude:
                                    {
                                      name: "Latitude",
                                      transform: function(val) {
                                        return Math.round(val*100)/10000;
                                      }
                                    }
                                  }));
  widget_list.push(new TextWidget('gps_n_or_s', {S330NorS: {name: "N/S"}}));

  widget_list.push(new TextWidget('gps_lon',
                                  {S330Longitude:
                                    {
                                      name: "Longitude",
                                      transform: function(val) {
                                        return Math.round(val*100)/10000;
                                      }
                                    }
                                  }));
  widget_list.push(new TextWidget('gps_e_or_w', {S330EorW: {name: "E/W"}}));

  function pco2_time_tag_to_julian(time_tag) {
    return parseInt(time_tag).toString().substring(4,7);
  }
  widget_list.push(new TextWidget('gmt_julian_date',
                                  {PCO2TimeTag: {
                                     name: "Julian Date",
                                     transform: pco2_time_tag_to_julian}}));

  function s330_time_to_time_str(time) {
    time /= 100;
    var seconds = (100*(time - Math.floor(time))).toFixed(2);
    time = Math.floor(time);
    time /= 100;
    var minutes = (100*(time - Math.floor(time))).toFixed(0);
    time = Math.floor(time);
    time /= 100;
    var hours = (100*(time - Math.floor(time))).toFixed(0);

    return (hours < 10 ? '0' : '') + hours
            + ':' + (minutes < 10 ? '0' : '') + minutes
            + ':' + (seconds < 10 ? '0' : '') + seconds;
  }

  widget_list.push(new TextWidget('gmt_time', {
                                    S330GPSTime: {
                                      name: "GMT Time",
                                      transform: function(val) {
                                        return s330_time_to_time_str(val);
                                      }
                                    }
                                  }));

  function month_to_name(month) {
    var month_map = {
      01: 'Jan', 02: 'Feb', 03: 'Mar', 04: 'Apr',
      05: 'May', 06: 'Jun', 07: 'Jul', 08: 'Aug',
      09: 'Sep', 10: 'Oct', 11: 'Nov', 12: 'Dec'};
    return month_map[parseInt(month)];
  }
  widget_list.push(new TextWidget('gmt_day', {S330GPSDay: {name: "GMT Day"}}));
  widget_list.push(new TextWidget('gmt_month', {S330GPSMonth: {
                                      name: "GMT Month",
                                      transform: function(val) {
                                        return month_to_name(val);
                                      }
                                    }
                                  }));
  widget_list.push(new TextWidget('gmt_year', {S330GPSYear: {name: "GMT Year"}}));

      //////////////////
      // Relative winds
      var rel_wind_fields = {
        MwxPortRelWindDir: {
          name: 'Port Relative Wind',
          color: 'red',
        },
        MwxStbdRelWindDir: {
          name: 'Stbd Relative Wind',
          color: 'green',
        }
      };
      widget_list.push(new DialWidget('rel-wind-container', rel_wind_fields));


      //////////////////
      // True winds
      var true_wind_fields = {
        PortTrueWindDir: {
          name: 'Port True Wind',
          color: 'red',
          transform: function(val) { return Math.round(val*100)/100; }
        },
        StbdTrueWindDir: {
          name: 'Stbd True Wind',
          color: 'green',
          transform: function(val) { return Math.round(val*100)/100; }
        }
      };
      widget_list.push(new DialWidget('true-wind-container', true_wind_fields));

      var port_rel_speed_fields = {
        MwxPortRelWindSpeed: {
          name: "Port Rel Wind Speed",
        }
      };
      widget_list.push(new TextWidget('port_rel_speed', port_rel_speed_fields));

      var stbd_rel_speed_fields = {
        MwxStbdRelWindSpeed: {
          name: "Stbd Rel Wind Speed",
        }
      };
      widget_list.push(new TextWidget('stbd_rel_speed', stbd_rel_speed_fields));

      var port_true_speed_fields = {
        PortTrueWindSpeed: {
          name: "Port True Wind Speed",
          transform: function(val) { return Math.round(val*100)/100; }
        }
      };
      widget_list.push(new TextWidget('port_true_speed',
                                      port_true_speed_fields));

      var stbd_true_speed_fields = {
        StbdTrueWindSpeed: {
          name: "Stbd True Wind Speed",
          transform: function(val) { return Math.round(val*100)/100; }
        }
      };
      widget_list.push(new TextWidget('stbd_true_speed',
                                      stbd_true_speed_fields));

      widget_list.push(new TextWidget('course_true',
                                      {S330CourseTrue: {name: 'Course'}}));
      widget_list.push(new TextWidget('heading_true',
                                      {S330HeadingTrue: {name: 'Heading'}}));
      widget_list.push(new TextWidget('sog_kt',
                                      {S330SpeedKt: {name: 'Speed'}}));

  widget_list.push(new TextWidget('pitch', { S330Pitch: {name: 'Pitch'}}));
  widget_list.push(new TextWidget('roll', { S330Roll: {name: 'Roll'}}));

  var widget_server = new WidgetServer(widget_list,
                                       WEBSOCKET_DATA_SERVER);
  widget_server.serve();
</script>
</body>
</html>
